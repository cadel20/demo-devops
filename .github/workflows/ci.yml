name: ğŸ³ CI Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - '**.py'
      - '**.js'
      - '**.html'
      - '**.css'
      - 'Dockerfile'
      - 'docker-compose*.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip-tests:
        description: 'Skip Docker tests'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ======================
  # 1. VALIDATION
  # ======================
  validate:
    name: "ğŸ” Validation du code"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: "ğŸ“¥ Checkout du code"
      uses: actions/checkout@v4
    
    - name: "ğŸ“ VÃ©rifier la structure"
      run: |
        echo "ğŸ“‚ Structure du projet:"
        ls -la
        echo ""
        if [ -f "Dockerfile" ]; then
          echo "âœ… Dockerfile trouvÃ©"
          echo "ğŸ“‹ PremiÃ¨res lignes du Dockerfile:"
          head -15 Dockerfile
        else
          echo "âŒ Dockerfile non trouvÃ©"
          exit 1
        fi
        if [ -f "index.html" ]; then
          echo "âœ… index.html trouvÃ©"
        else
          echo "âš ï¸  index.html non trouvÃ© (nÃ©cessaire pour GitHub Pages)"
        fi

  # ======================
  # 2. BUILD DOCKER
  # ======================
  build:
    name: "ğŸ—ï¸ Build Docker"
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 10
    
    steps:
    - name: "ğŸ“¥ Checkout du code"
      uses: actions/checkout@v4
    
    - name: "ğŸ”§ Setup Docker Buildx"
      uses: docker/setup-buildx-action@v3
    
    - name: "ğŸ—ï¸ Build Docker image"
      run: |
        echo "ğŸ”¨ Construction de l'image Docker..."
        docker build \
          --tag demo-devops-app:ci-${{ github.sha }} \
          --label "ci.build=${{ github.run_id }}" \
          --label "ci.sha=${{ github.sha }}" \
          .
        
        echo "âœ… Image construite:"
        docker images demo-devops-app

  # ======================
  # 3. TESTS DOCKER
  # ======================
  test:
    name: "ğŸ§ª Tests Docker"
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !github.event.inputs.skip-tests || github.event.inputs.skip-tests == 'false' }}
    timeout-minutes: 10
    
    steps:
    - name: "ğŸ“¥ Checkout du code"
      uses: actions/checkout@v4
    
    - name: "ğŸ§ª Tests fonctionnels"
      run: |
        echo "ğŸ§ª DÃ©marrage des tests Docker..."
        
        # Charger l'image construite prÃ©cÃ©demment
        docker load -i /tmp/docker-image.tar 2>/dev/null || echo "âš ï¸  Pas d'image prÃ©cÃ©dente, rebuild..."
        
        # Rebuild si nÃ©cessaire
        if ! docker image inspect demo-devops-app:ci-${{ github.sha }} &>/dev/null; then
          echo "ğŸ”¨ Reconstruction de l'image..."
          docker build -t demo-devops-app:ci-${{ github.sha }} .
        fi
        
        # Test 1: Conteneur dÃ©marre
        echo "1. Test dÃ©marrage conteneur..."
        CONTAINER_ID=$(docker run -d --rm -p 8081:80 demo-devops-app:ci-${{ github.sha }})
        sleep 5
        
        # Test 2: Conteneur en vie
        echo "2. VÃ©rification Ã©tat conteneur..."
        if docker ps | grep -q $CONTAINER_ID; then
          echo "âœ… Conteneur en cours d'exÃ©cution"
          
          # Test 3: RÃ©ponse HTTP
          echo "3. Test rÃ©ponse HTTP..."
          if curl -s -f -o /dev/null --max-time 10 http://localhost:8081; then
            echo "âœ… Site accessible sur http://localhost:8081"
            TEST_SCORE=100
          else
            echo "âš ï¸  Site non accessible (mais conteneur actif)"
            TEST_SCORE=70
          fi
          
          # Nettoyage
          docker stop $CONTAINER_ID
          wait $CONTAINER_ID 2>/dev/null || true
        else
          echo "âŒ Conteneur non dÃ©marrÃ©"
          docker logs $CONTAINER_ID 2>/dev/null || true
          TEST_SCORE=0
        fi
        
        echo "ğŸ“Š Score des tests: $TEST_SCORE/100"
        if [ $TEST_SCORE -lt 60 ]; then
          echo "âŒ Tests Ã©chouÃ©s"
          exit 1
        fi

  # ======================
  # 4. SÃ‰CURITÃ‰
  # ======================
  security:
    name: "ğŸ›¡ï¸ Analyse de sÃ©curitÃ©"
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 8
    
    steps:
    - name: "ğŸ“¥ Checkout du code"
      uses: actions/checkout@v4
    
    - name: "ğŸ—ï¸ Rebuild pour sÃ©curitÃ©"
      run: |
        docker build -t demo-devops-app:security-scan .
    
    - name: "ğŸ›¡ï¸ Scan Trivy (images)"
      continue-on-error: true
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'demo-devops-app:security-scan'
        format: 'sarif'
        output: 'trivy-image-results.sarif'
        severity: 'CRITICAL,HIGH'
        ignore-unfixed: false
    
    - name: "ğŸ“‹ Scan Trivy (fichiers)"
      continue-on-error: true
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-fs-results.sarif'
        severity: 'CRITICAL,HIGH'
    
    - name: "ğŸ“¤ Upload rapports sÃ©curitÃ©"
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          trivy-image-results.sarif
          trivy-fs-results.sarif
        retention-days: 30

  # ======================
  # 5. RAPPORT FINAL
  # ======================
  report:
    name: "ğŸ“Š Rapport CI"
    runs-on: ubuntu-latest
    needs: [validate, build, test, security]
    if: always()
    timeout-minutes: 2
    
    steps:
    - name: "ğŸ“‹ GÃ©nÃ©rer rapport"
      run: |
        echo "========================================"
        echo "ğŸ“Š RAPPORT CI - DOCKER TESTS"
        echo "========================================"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”— Workflow: ${{ github.workflow }}"
        echo "ğŸ·ï¸  Ref: ${{ github.ref }}"
        echo "ğŸ†” Run ID: ${{ github.run_id }}"
        echo "ğŸ†” SHA: ${GITHUB_SHA:0:8}"
        echo ""
        echo "âœ… RÃ‰SULTATS:"
        echo "  Validation: ${{ needs.validate.result }}"
        echo "  Build: ${{ needs.build.result }}"
        echo "  Tests: ${{ needs.test.result }}"
        echo "  SÃ©curitÃ©: ${{ needs.security.result }}"
        echo ""
        echo "ğŸ³ IMAGE DOCKER:"
        echo "  Tag: demo-devops-app:ci-${{ github.sha }}"
        echo "  Tests: ${{ needs.test.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}"
        echo ""
        echo "ğŸ›¡ï¸ SÃ‰CURITÃ‰:"
        echo "  Scan image: ${{ needs.security.result == 'success' && 'âœ…' || 'âš ï¸ ' }}"
        echo "  Rapports disponibles en artifacts"
        echo ""
        echo "â±ï¸  TEMPS D'EXÃ‰CUTION:"
        echo "  DÃ©but: ${{ needs.validate.outputs.start_time || 'N/A' }}"
        echo "========================================"
    
    - name: "ğŸ“¤ Notifier sur Slack (optionnel)"
      if: failure()
      continue-on-error: true
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#ci-alerts'
        username: 'CI Docker Bot'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}