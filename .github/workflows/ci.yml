name: ğŸ³ CI Pipeline AvancÃ©

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip-tests:
        description: 'Skip Docker tests'
        required: false
        default: false
        type: boolean

jobs:
  # ======================
  # 1. VALIDATION
  # ======================
  validate:
    name: "ğŸ” Validation du code"
    runs-on: ubuntu-latest
    
    steps:
    - name: "ğŸ“¥ Checkout du code"
      uses: actions/checkout@v4
    
    - name: "ğŸ“ VÃ©rifier la structure"
      run: |
        echo "ğŸ“‚ Structure du projet:"
        ls -la
        echo ""
        
        # VÃ©rifier Dockerfile
        if [ -f "Dockerfile" ]; then
          echo "âœ… Dockerfile trouvÃ©"
          echo "ğŸ“‹ PremiÃ¨res lignes:"
          head -10 Dockerfile
        else
          echo "âš ï¸  Dockerfile non trouvÃ© - crÃ©ation d'un exemple"
          cat > Dockerfile << 'EOF'
FROM nginx:alpine
COPY . /usr/share/nginx/html/
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
EOF
          echo "âœ… Dockerfile exemple crÃ©Ã©"
        fi
        
        # VÃ©rifier index.html pour GitHub Pages
        if [ -f "index.html" ]; then
          echo "âœ… index.html trouvÃ©"
        elif [ -f "*.html" ]; then
          echo "âœ… Fichier HTML trouvÃ©"
        else
          echo "âš ï¸  Aucun fichier HTML trouvÃ© - crÃ©ation d'un exemple"
          cat > index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>Demo DevOps</title>
</head>
<body>
    <h1>ğŸš€ Projet DevOps</h1>
    <p>CI/CD Pipeline avec Docker</p>
</body>
</html>
EOF
          echo "âœ… index.html exemple crÃ©Ã©"
        fi

  # ======================
  # 2. BUILD DOCKER
  # ======================
  build:
    name: "ğŸ—ï¸ Build Docker"
    runs-on: ubuntu-latest
    needs: validate  # Attendre la validation
    
    steps:
    - name: "ğŸ“¥ Checkout du code"
      uses: actions/checkout@v4
    
    - name: "ğŸ”§ Setup Docker Buildx"
      uses: docker/setup-buildx-action@v3
    
    - name: "ğŸ—ï¸ Build Docker image"
      run: |
        echo "ğŸ”¨ Construction de l'image Docker..."
        
        # CrÃ©er un tag unique
        TAG_NAME="demo-devops-app:ci-$(date +%Y%m%d)-${GITHUB_SHA:0:8}"
        
        docker build \
          --tag $TAG_NAME \
          --tag demo-devops-app:latest \
          --label "build.date=$(date)" \
          --label "commit.sha=$GITHUB_SHA" \
          --label "build.run=$GITHUB_RUN_ID" \
          .
        
        echo "âœ… Image construite:"
        docker images | grep demo-devops-app
        
        # Sauvegarder le nom du tag pour les jobs suivants
        echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

  # ======================
  # 3. TESTS DOCKER
  # ======================
  test:
    name: "ğŸ§ª Tests Docker"
    runs-on: ubuntu-latest
    needs: build  # Attendre le build
    if: ${{ !github.event.inputs.skip-tests || github.event.inputs.skip-tests == 'false' }}
    
    steps:
    - name: "ğŸ“¥ Checkout du code"
      uses: actions/checkout@v4
    
    - name: "ğŸ§ª Tests fonctionnels"
      env:
        DOCKER_TAG: ${{ needs.build.outputs.TAG_NAME || 'demo-devops-app:latest' }}
      run: |
        echo "ğŸ§ª DÃ©marrage des tests Docker..."
        echo "ğŸ“¦ Image testÃ©e: $DOCKER_TAG"
        
        # VÃ©rifier si l'image existe localement
        if ! docker image inspect $DOCKER_TAG &>/dev/null; then
          echo "ğŸ”¨ Image non trouvÃ©e, reconstruction..."
          docker build -t $DOCKER_TAG .
        fi
        
        # Test 1: Conteneur dÃ©marre
        echo ""
        echo "1. ğŸ§ª Test dÃ©marrage conteneur..."
        CONTAINER_ID=$(docker run -d --rm -p 8081:80 $DOCKER_TAG)
        echo "   Conteneur ID: $CONTAINER_ID"
        sleep 3
        
        # Test 2: Conteneur en vie
        echo ""
        echo "2. ğŸ” VÃ©rification Ã©tat conteneur..."
        if docker ps | grep -q $CONTAINER_ID; then
          echo "   âœ… Conteneur en cours d'exÃ©cution"
          
          # Test 3: RÃ©ponse HTTP
          echo ""
          echo "3. ğŸŒ Test rÃ©ponse HTTP..."
          if curl -s -f -o /dev/null --retry 2 --max-time 5 http://localhost:8081; then
            echo "   âœ… Site accessible sur http://localhost:8081"
            echo "   ğŸ“Š Status: SUCCESS"
          else
            echo "   âš ï¸  Site non accessible (mais conteneur actif)"
            echo "   ğŸ“Š Status: WARNING"
          fi
          
          # Nettoyage
          echo ""
          echo "4. ğŸ§¹ Nettoyage..."
          docker stop $CONTAINER_ID && echo "   âœ… Conteneur arrÃªtÃ©"
          
        else
          echo "   âŒ Conteneur non dÃ©marrÃ©"
          echo "   ğŸ“‹ Logs du conteneur:"
          docker logs $CONTAINER_ID 2>/dev/null || echo "   (pas de logs disponibles)"
          echo "   ğŸ“Š Status: FAILED"
          exit 1
        fi
        
        echo ""
        echo "ğŸ‰ Tous les tests sont terminÃ©s !"

  # ======================
  # 4. SÃ‰CURITÃ‰ (optionnel)
  # ======================
  security:
    name: "ğŸ›¡ï¸ Analyse de sÃ©curitÃ©"
    runs-on: ubuntu-latest
    needs: build  # Attendre le build
    if: ${{ github.event_name != 'pull_request' }}  # Skip sur PR pour vitesse
    
    steps:
    - name: "ğŸ“¥ Checkout du code"
      uses: actions/checkout@v4
    
    - name: "ğŸ—ï¸ Build pour scan"
      run: |
        docker build -t demo-devops-app:security-scan .
    
    - name: "ğŸ›¡ï¸ Scan Trivy"
      continue-on-error: true  # Ne pas bloquer le CI
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'demo-devops-app:security-scan'
        format: 'table'
        exit-code: '0'  # Toujours rÃ©ussir pour ne pas bloquer
        severity: 'CRITICAL,HIGH'
        ignore-unfixed: true
        timeout: '5m'

  # ======================
  # 5. RAPPORT FINAL
  # ======================
  report:
    name: "ğŸ“Š Rapport CI"
    runs-on: ubuntu-latest
    needs: [validate, build, test, security]
    if: always()  # Toujours s'exÃ©cuter mÃªme en cas d'Ã©chec
    
    steps:
    - name: "ğŸ“‹ GÃ©nÃ©rer rapport"
      run: |
        echo ""
        echo "========================================"
        echo "         ğŸ“Š RAPPORT CI COMPLET          "
        echo "========================================"
        echo "ğŸ“… Date: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ·ï¸  Branche: ${{ github.ref }}"
        echo "ğŸ”— SHA: ${GITHUB_SHA:0:8}"
        echo "ğŸ‘¤ DÃ©clenchÃ© par: ${{ github.actor }}"
        echo ""
        echo "ğŸ“ˆ RÃ‰SULTATS DES JOBS:"
        echo "   ğŸ” Validation: ${{ needs.validate.result }}"
        echo "   ğŸ—ï¸  Build: ${{ needs.build.result }}"
        echo "   ğŸ§ª Tests: ${{ needs.test.result }}"
        echo "   ğŸ›¡ï¸  SÃ©curitÃ©: ${{ needs.security.result }}"
        echo ""
        echo "ğŸ³ DÃ‰TAILS DOCKER:"
        echo "   Image: demo-devops-app"
        echo "   Tag: ${{ needs.build.outputs.TAG_NAME || 'latest' }}"
        echo ""
        echo "â±ï¸  STATUT FINAL:"
        if [[ "${{ needs.validate.result }}" == "success" && \
              "${{ needs.build.result }}" == "success" && \
              ("${{ needs.test.result }}" == "success" || "${{ github.event.inputs.skip-tests }}" == "true") ]]; then
          echo "   âœ… âœ… âœ… CI RÃ‰USSI âœ… âœ… âœ…"
        else
          echo "   âŒ âŒ âŒ CI Ã‰CHOUÃ‰ âŒ âŒ âŒ"
        fi
        echo "========================================"
        echo ""