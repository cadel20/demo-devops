name: ğŸ—ï¸ Terraform Validation

on:
  push:
    branches: [main]
    paths:
      - 'infrastructure/**'
      - '**.tf'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  terraform:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # RÃ©cupÃ¨re tout l'historique
    
    - name: ğŸ” Debug - Analyse du commit
      run: |
        echo "ğŸ” ANALYSE DU DÃ‰CLENCHEMENT"
        echo "============================="
        echo "ğŸ“… Commit SHA: ${{ github.sha }}"
        echo "ğŸ·ï¸  Branche: ${{ github.ref }}"
        echo "ğŸ‘¤ Auteur: ${{ github.actor }}"
        echo ""
        
        # Voir les fichiers modifiÃ©s dans le dernier commit
        echo "ğŸ“‹ Fichiers modifiÃ©s dans ce commit:"
        if [ "${{ github.event_name }}" = "push" ]; then
          # Pour push, comparer avec le commit prÃ©cÃ©dent
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || \
          echo "Premier commit sur cette branche"
        else
          # Pour PR ou autre
          git log -1 --name-only --oneline
        fi
        
        echo ""
        echo "ğŸ” Fichiers correspondant aux patterns:"
        echo "- Dans infrastructure/:"
        find infrastructure -type f 2>/dev/null | head -10 || echo "  (aucun)"
        echo "- Fichiers .tf Ã  la racine:"
        find . -maxdepth 1 -name "*.tf" 2>/dev/null || echo "  (aucun)"
        echo "============================="
    
    - name: âš™ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: "1.6.0"
    
    - name: ğŸ” VÃ©rifier fichiers
      id: check-files
      run: |
        echo "ğŸ” VÃ©rification des fichiers Terraform..."
        
        # Chercher des fichiers .tf n'importe oÃ¹
        ALL_TF_FILES=$(find . -name "*.tf" -type f 2>/dev/null | wc -l)
        INFRA_TF_FILES=$(find infrastructure -name "*.tf" -type f 2>/dev/null | wc -l)
        
        echo "ğŸ“Š Statistiques:"
        echo "  Total fichiers .tf: $ALL_TF_FILES"
        echo "  Fichiers dans infrastructure/: $INFRA_TF_FILES"
        
        if [ $ALL_TF_FILES -gt 0 ]; then
          echo "âœ… Terraform dÃ©tectÃ©"
          echo "ğŸ“‹ Liste des fichiers:"
          find . -name "*.tf" -type f 2>/dev/null | head -10
          echo "has_tf=true" >> $GITHUB_OUTPUT
        else
          echo "â„¹ï¸  Aucun fichier Terraform (.tf) trouvÃ©"
          echo "has_tf=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ—ï¸ Init & Validate
      if: steps.check-files.outputs.has_tf == 'true'
      working-directory: ./infrastructure
      run: |
        echo "ğŸ”§ Initialisation Terraform..."
        terraform init -input=false
        
        echo "âœ… Validation syntaxique..."
        terraform validate
        
        echo "ğŸ“ Application du formatage standard..."
        terraform fmt
        
        echo "âœ“ Formatage appliquÃ©"
    
    - name: ğŸ“‹ Plan Terraform
      if: steps.check-files.outputs.has_tf == 'true'
      working-directory: ./infrastructure
      run: |
        echo "ğŸ“‹ GÃ©nÃ©ration du plan Terraform..."
        terraform plan -no-color
    
    - name: ğŸ“Š Rapport final
      if: always()
      run: |
        echo ""
        echo "========================================"
        echo "          ğŸ—ï¸  RAPPORT TERRAFORM          "
        echo "========================================"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ·ï¸  Branche: ${{ github.ref }}"
        echo "ğŸ”— SHA: ${GITHUB_SHA:0:8}"
        echo "ğŸ”„ Ã‰vÃ©nement: ${{ github.event_name }}"
        echo "ğŸ“Š Terraform dÃ©tectÃ©: ${{ steps.check-files.outputs.has_tf }}"
        
        if [ "${{ steps.check-files.outputs.has_tf }}" = "true" ]; then
          echo "âœ… Workflow exÃ©cutÃ© avec succÃ¨s"
          echo "ğŸ’¾ Validation terminÃ©e"
        else
          echo "â„¹ï¸  Workflow non exÃ©cutÃ© (pas de fichiers Terraform)"
          echo "ğŸ’¡ Pour dÃ©clencher ce workflow:"
          echo "   1. Modifiez un fichier dans 'infrastructure/'"
          echo "   2. CrÃ©ez/modifiez un fichier '.tf'"
          echo "   3. Utilisez 'Run workflow' manuellement"
        fi
        echo "========================================"