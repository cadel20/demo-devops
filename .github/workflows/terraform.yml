name: ğŸ—ï¸ Terraform Validation

on:
  push:
    branches: [main]
    paths:
      - 'infrastructure/**'
      - '**.tf'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  terraform:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: âš™ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: "1.6.0"
    
    - name: ğŸ” VÃ©rifier fichiers
      id: check-files
      run: |
        if [ -d "infrastructure" ] && [ -n "$(find infrastructure -name '*.tf')" ]; then
          echo "has_tf=true" >> $GITHUB_OUTPUT
        else
          echo "has_tf=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ—ï¸ Init & Validate
      if: steps.check-files.outputs.has_tf == 'true'
      working-directory: ./infrastructure
      run: |
        echo "ğŸ”§ Initialisation Terraform..."
        terraform init -input=false
        
        echo "âœ… Validation syntaxique..."
        terraform validate
        
        echo "ğŸ“ Application du formatage standard..."
        # Applique le formatage automatiquement
        terraform fmt
        
        echo "âœ“ Formatage appliquÃ©"
    
    - name: ğŸ“‹ Plan Terraform
      if: steps.check-files.outputs.has_tf == 'true'
      working-directory: ./infrastructure
      run: |
        echo "ğŸ“‹ GÃ©nÃ©ration du plan Terraform..."
        terraform plan -no-color
    
    - name: ğŸ’¾ Commit les changements de format
      if: steps.check-files.outputs.has_tf == 'true'
      run: |
        # VÃ©rifie si terraform fmt a modifiÃ© des fichiers
        if git diff --name-only | grep -q '\.tf$'; then
          echo "ğŸ“ Fichiers Terraform modifiÃ©s par terraform fmt"
          echo "ğŸ“‹ Fichiers modifiÃ©s:"
          git diff --name-only | grep '\.tf$'
          
          # Configure git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Commit les changements
          git add .
          git commit -m "style: Format Terraform files [skip ci]" || echo "âš ï¸  Pas de changements Ã  committer"
          
          # Pousse les changements (optionnel)
          # git push origin HEAD:${{ github.ref }} || echo "âš ï¸  Push Ã©chouÃ©"
        else
          echo "âœ… Aucun changement de formatage nÃ©cessaire"
        fi