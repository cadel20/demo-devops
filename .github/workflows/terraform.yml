name: ğŸ—ï¸ Terraform Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  terraform:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ” DÃ©tection automatique
      id: detect
      run: |
        echo "ğŸ” Recherche de fichiers Terraform..."
        
        # Chercher tous les fichiers .tf
        TF_FILES=$(find . -name "*.tf" -type f 2>/dev/null | wc -l)
        TF_DIRS=$(find . -name "*.tf" -type f -exec dirname {} \; 2>/dev/null | sort -u | head -5)
        
        echo "ğŸ“Š Statistiques:"
        echo "  Fichiers .tf trouvÃ©s: $TF_FILES"
        
        if [ $TF_FILES -gt 0 ]; then
          echo "âœ… Terraform dÃ©tectÃ©"
          echo "ğŸ“ Dossiers contenant .tf:"
          echo "$TF_DIRS"
          
          # Prendre le premier dossier (gÃ©nÃ©ralement infrastructure/)
          MAIN_TF_DIR=$(echo "$TF_DIRS" | head -1)
          echo "MAIN_DIR=$MAIN_TF_DIR" >> $GITHUB_ENV
          echo "has_tf=true" >> $GITHUB_OUTPUT
        else
          echo "â„¹ï¸  Aucun fichier Terraform (.tf) trouvÃ©"
          echo "has_tf=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ—ï¸ Init & Validate
      if: steps.detect.outputs.has_tf == 'true'
      working-directory: ${{ env.MAIN_DIR }}
      run: |
        echo "ğŸ”§ Initialisation Terraform dans: $(pwd)"
        terraform init -input=false
        
        echo "âœ… Validation syntaxique..."
        terraform validate
        
        echo "ğŸ“ Formatage automatique..."
        terraform fmt
        
        echo "âœ“ Terraform prÃªt"
    
    - name: ğŸ“‹ Plan Terraform
      if: steps.detect.outputs.has_tf == 'true'
      working-directory: ${{ env.MAIN_DIR }}
      run: |
        echo "ğŸ“‹ GÃ©nÃ©ration du plan..."
        terraform plan -no-color
    
    - name: ğŸ“Š Rapport
      if: always()
      run: |
        echo ""
        echo "========================================"
        echo "     ğŸ—ï¸  RAPPORT TERRAFORM VALIDATION    "
        echo "========================================"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ·ï¸  Branche: ${{ github.ref }}"
        echo "ğŸ”„ Ã‰vÃ©nement: ${{ github.event_name }}"
        echo "ğŸ“Š Terraform dÃ©tectÃ©: ${{ steps.detect.outputs.has_tf }}"
        
        if [ "${{ steps.detect.outputs.has_tf }}" = "true" ]; then
          echo "ğŸ“ Dossier: ${{ env.MAIN_DIR }}"
          echo "âœ… Workflow exÃ©cutÃ© avec succÃ¨s"
        else
          echo "â„¹ï¸  Aucune configuration Terraform trouvÃ©e"
          echo "ğŸ’¡ Pour utiliser Terraform:"
          echo "   1. CrÃ©ez un dossier 'infrastructure/'"
          echo "   2. Ajoutez des fichiers .tf (main.tf, variables.tf...)"
        fi
        echo "========================================"