name: ğŸ—ï¸ Terraform Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  terraform:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ” Debug - VÃ©rifier structure
      run: |
        echo "ğŸ“‚ Structure du projet:"
        find . -type f -name "*.tf" | head -20
        echo ""
        echo "ğŸ“ Dossiers:"
        ls -la
        echo ""
        if [ -d "infrastructure" ]; then
          echo "âœ… Dossier 'infrastructure' trouvÃ©"
          echo "ğŸ“‹ Fichiers Terraform dans infrastructure/:"
          find infrastructure -name "*.tf" 2>/dev/null || echo "Aucun fichier .tf"
        else
          echo "âŒ Dossier 'infrastructure' non trouvÃ©"
        fi
    
    - name: âš™ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: "1.6.0"
    
    - name: ğŸ—ï¸ Valider Terraform (si prÃ©sent)
      id: validate-tf
      run: |
        # Chercher des fichiers .tf n'importe oÃ¹
        TF_FILES=$(find . -name "*.tf" -type f | head -5)
        
        if [ -n "$TF_FILES" ]; then
          echo "âœ… Fichiers Terraform trouvÃ©s:"
          echo "$TF_FILES"
          
          # Trouver le premier dossier contenant des .tf
          TF_DIR=$(dirname "$(echo "$TF_FILES" | head -1)")
          echo "ğŸ“ Dossier Terraform: $TF_DIR"
          
          # Initialiser et valider
          cd "$TF_DIR"
          terraform init -input=false
          terraform validate
          terraform fmt -check
          
          echo "has_tf=true" >> $GITHUB_OUTPUT
          echo "tf_dir=$TF_DIR" >> $GITHUB_OUTPUT
        else
          echo "â„¹ï¸  Aucun fichier Terraform (.tf) trouvÃ©"
          echo "has_tf=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ“‹ Plan Terraform
      if: steps.validate-tf.outputs.has_tf == 'true'
      run: |
        echo "ğŸ“‹ GÃ©nÃ©ration du plan Terraform..."
        cd "${{ steps.validate-tf.outputs.tf_dir }}"
        terraform plan -no-color
    
    - name: ğŸ“ Rapport final
      if: always()
      run: |
        echo "========================================"
        echo "ğŸ—ï¸  RAPPORT TERRAFORM"
        echo "========================================"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ·ï¸  Branche: ${{ github.ref }}"
        echo "ğŸ“Š Terraform dÃ©tectÃ©: ${{ steps.validate-tf.outputs.has_tf }}"
        echo "ğŸ“ Dossier: ${{ steps.validate-tf.outputs.tf_dir || 'N/A' }}"
        
        if [ "${{ steps.validate-tf.outputs.has_tf }}" = "true" ]; then
          echo "âœ… Terraform configurÃ© et validÃ©"
        else
          echo "â„¹ï¸  Aucune configuration Terraform trouvÃ©e"
          echo "ğŸ’¡ CrÃ©ez un dossier 'infrastructure/' avec des fichiers .tf"
        fi
        echo "========================================"