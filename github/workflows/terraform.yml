name: ğŸ—ï¸ Terraform Validation

on:
  push:
    branches: [main]
    paths:
      - 'infrastructure/**'  # Se dÃ©clenche seulement sur changement Terraform
      - '**.tf'
  pull_request:
    branches: [main]
  workflow_dispatch:  # ExÃ©cution manuelle

jobs:
  terraform:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: âš™ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: "1.6.0"
    
    - name: ğŸ” VÃ©rifier fichiers
      id: check-files
      run: |
        if [ -d "infrastructure" ] && [ -n "$(find infrastructure -name '*.tf')" ]; then
          echo "has_tf=true" >> $GITHUB_OUTPUT
        else
          echo "has_tf=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ—ï¸ Init & Validate
      if: steps.check-files.outputs.has_tf == 'true'
      working-directory: ./infrastructure
      run: |
        echo "Initialisation Terraform..."
        terraform init -input=false
        
        echo "Validation syntaxique..."
        terraform validate
        
        echo "VÃ©rification format..."
        terraform fmt -check
    
    - name: ğŸ“‹ Plan Terraform
      if: steps.check-files.outputs.has_tf == 'true'
      working-directory: ./infrastructure
      run: |
        echo "GÃ©nÃ©ration du plan..."
        terraform plan -no-color