name: ğŸš€ Deploy HTML Website via FTP

on:
  push:
    branches: [main]
    paths:
      - '**.html'
      - '**.css'
      - '**.js'
      - 'images/**'
      - 'assets/**'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Dry run (test sans dÃ©ployer)'
        required: false
        default: true
        type: boolean
      cleanup:
        description: 'Nettoyer les fichiers distants'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # RÃ©cupÃ¨re tout l'historique
        
    - name: ğŸ” VÃ©rifier les changements
      id: changes
      run: |
        echo "Dernier commit: $(git log -1 --oneline)"
        echo "Fichiers modifiÃ©s:"
        git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "Premier dÃ©ploiement"
        
    - name: ğŸ“Š Afficher la taille des fichiers
      run: |
        echo "ğŸ“ Structure du projet:"
        find . -type f -name "*.html" -o -name "*.css" -o -name "*.js" | head -20
        echo ""
        echo "ğŸ“¦ Taille totale: $(du -sh . | cut -f1)"
        
    - name: ğŸ” VÃ©rifier la configuration FTP
      id: check-ftp
      run: |
        if [ -z "${{ secrets.FTP_SERVER }}" ]; then
          echo "âŒ FTP_SERVER non configurÃ©"
          echo "status=error" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        if [ -z "${{ secrets.FTP_USERNAME }}" ]; then
          echo "âŒ FTP_USERNAME non configurÃ©"
          echo "status=error" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ… Configuration FTP vÃ©rifiÃ©e"
        echo "status=success" >> $GITHUB_OUTPUT
        
    - name: ğŸš€ DÃ©ployer via FTP
      if: steps.check-ftp.outputs.status == 'success'
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: /htdocs/
        dry-run: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry-run == 'true' || false }}
        dangerous-clean-slate: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.cleanup == 'true' || false }}
        exclude: |
          **/.git*
          **/.github/**
          **/node_modules/**
          **/*.md
          **/*.yml
          **/*.yaml
          Dockerfile
          .gitignore
          .dockerignore
        log-level: verbose
        timeout: 120s
        
    - name: ğŸ“ GÃ©nÃ©rer un rapport de dÃ©ploiement
      if: always()
      run: |
        echo "========================================"
        echo "ğŸ“‹ RAPPORT DE DÃ‰PLOIEMENT FTP"
        echo "========================================"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”— DÃ©clencheur: ${{ github.event_name }}"
        echo "ğŸ·ï¸  Branche: ${{ github.ref }}"
        echo "ğŸ‘¤ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Auteur: ${{ github.actor }}"
        echo ""
        echo "âš™ï¸ Configuration:"
        echo "  Serveur: ${{ secrets.FTP_SERVER != '' && 'âœ… ConfigurÃ©' || 'âŒ Manquant' }}"
        echo "  Utilisateur: ${{ secrets.FTP_USERNAME != '' && 'âœ… ConfigurÃ©' || 'âŒ Manquant' }}"
        echo "  Mot de passe: ${{ secrets.FTP_PASSWORD != '' && 'âœ… ConfigurÃ©' || 'âŒ Manquant' }}"
        echo ""
        echo "ğŸ“Š Statistiques:"
        echo "  Fichiers HTML: $(find . -name "*.html" | wc -l)"
        echo "  Fichiers CSS: $(find . -name "*.css" | wc -l)"
        echo "  Fichiers JS: $(find . -name "*.js" | wc -l)"
        echo "  Images: $(find . -name "*.jpg" -o -name "*.png" -o -name "*.gif" -o -name "*.svg" | wc -l)"
        echo "========================================"
        
    - name: ğŸ¯ Tester le dÃ©ploiement (optionnel)
      if: success()
      run: |
        echo "ğŸ§ª Test de connexion au site..."
        # Attendre que les fichiers soient dÃ©ployÃ©s
        sleep 10
        
        # Tester avec curl si l'URL est configurÃ©e
        if [ -n "${{ secrets.WEBSITE_URL }}" ]; then
          echo "ğŸŒ Test de ${{ secrets.WEBSITE_URL }}"
          if curl -s -f -o /dev/null ${{ secrets.WEBSITE_URL }}; then
            echo "âœ… Site accessible"
          else
            echo "âš ï¸  Site peut-Ãªtre inaccessible"
          fi
        else
          echo "â„¹ï¸  WEBSITE_URL non configurÃ©, skip du test"
        fi
        
    - name: ğŸ“¤ Notifier le rÃ©sultat
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'  # Optionnel
        username: 'FTP Deploy Bot'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}